  <link href="http://www.iderail.es/testiss/css/ol.css" rel="stylesheet">
  <style type="text/css">
  .map {
    float: left;
    padding: 10px 10px;
    height: 475px;
    width: 475px;
  }
  .mapOSM {
    float: left;
    padding: 10px 10px;
    height:475px;
    width: 475px;
  }
  .txtISS {
    float: left;
    padding: 5px 5px;
    height:115px;
    width: 115px;
  }
  .txtOSM {
    float: left;
    padding: 5px 5px;
    height:160px;
    width: 160px;
  }
  .container {
    margin-right: 10px;
    margin-left: 10px;
    }
  </style>

<div class="row">
    <!-- Success and Error Messages for the user --> 
    <div class="span6 offset2" style="height:10px">
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            <strong>Well done!</strong> Your answer has been saved
        </div>
        <div id="loading" class="alert alert-info" style="display:none;">
            <a class="close">×</a>
            Loading next task...
        </div>
        <div id="taskcompleted" class="alert alert-info" style="display:none;">
            <strong>The task has been completed!</strong> Thanks a lot!
        </div>
        <div id="finish" class="alert alert-success" style="display:none;">
            <strong>Congratulations!</strong> You have participated in all available tasks!
            <br/>
            <div class="alert-actions">
                <a class="btn small" href="/">Go back</a>
                <a class="btn small" href="/app">or, Check other applications</a>
            </div>
        </div>
        <div id="error" class="alert alert-error" style="display:none;">
            <a class="close">×</a>
            <strong>Error!</strong> Something went wrong, please contact the site administrators
        </div>
    </div> <!-- End Success and Error Messages for the user -->
</div> <!-- End of Row -->


<div class="row skeleton" style="width:1550px"> <!-- Start Skeleton Row-->
    <div class="span12" style="width:1550px"><!-- Start of Question and Submission DIV (column) -->
        <h1 id="question">Do you know about this City?</h1> <!-- The question will be loaded here -->
        <div id="step1" class="btn-group" style="text-align:center"> <!-- Start DIV for the submission buttons -->
            <div id="answer" class="btn-group" style="text-align:center"> <!-- Start DIV for the submission buttons -->
                <button class="btn btn-large btn-answer" value='save'>Save</button>
                <button class="btn btn-large btn-answer" value='404'>No photo</button>
                <button class="btn btn-large btn-answer" value='unknown'>I don't know</button>
            </div><!-- End of DIV for the submission buttons -->
        </div><!-- End of DIV for the submission buttons -->

        <!-- Link to picture data provided by NASA site -->
        <div>Use de [+] and [-] buttons to Zoom In and Zoom Out. Press Shift + Left Mouse Button to rotate the image <br><a id="hrefPicture" href='' target='_blank'>ISS picture data - Earth Science and Remote Sensing Unit, NASA-Johnson Space Center. "The Gateway to Astronaut Photography of Earth."</a></div>
          







        <!-- These are maps -->
        <div id="map" class="map"></div>
        <div id="mapOSM" class="mapOSM"></div>

        <!-- DataList to save  -->
        <form id='dataList' name='dataList'>
          <input type='button'   onClick="removeOptions()"; value='Remove Selected'><br>
            <SELECT id="xyValues" NAME="xyValues" class="txtISS" MULTIPLE size=6 width=5></SELECT>
            <SELECT id="lonlatValues" NAME="lonlatValues" class="txtOSM" MULTIPLE size=6 width=7></SELECT>
        </form>
    </div><!-- End of DIV for the submission buttons -->

        <!-- -------------- Social buttons ------------- -->
        <div>
          <div id="Twitter-share-section" style='float: left'>
                    <a href="https://twitter.com/share" class="twitter-share-button" data-text="Check this amazing picture and help us to georreference it" data-size="large" data-hashtags="NightCitiesISS">Tweet</a>
                </div>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
          </div> <!-- end twitter -->
                  
          <div class="g-plusone" style="float:left" data-annotation="inline" data-width="300"></div>

          <script type="text/javascript">
            window.___gcfg = {lang: 'es'};

            (function() {
              var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
              po.src = 'https://apis.google.com/js/platform.js';
              var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
            })();
          </script>
          <div style="float:left"> 
          <div id="fb-like" class="fb-like"  data-href="http://www.cowdcrafting.org/app/nightcitiesiss" data-layout="standard" data-action="like" data-show-faces="true" data-share="true"></div>
            <div id="fb-root"></div>
          </div>
          <script>(function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/es_ES/sdk.js#xfbml=1&version=v2.0";
            fjs.parentNode.insertBefore(js, fjs);
          }(document, 'script', 'facebook-jssdk'));</script>
          </div>
          <!-- -------------- End social buttons -------------------- -->

</div><!-- End of DIV for the submission buttons -->


<div class="row skeleton" style="margin-top:15px;"> <!-- Start Skeleton Row-->
    <div class="span8 offset2"><!-- Start of Question and Submission DIV (column) -->
        <p>You are working now on task: <span id="task-id" class="label label-warning">#</span></p>
        <p>You have completed: <span id="done" class="label label-info"></span> tasks from
        <!-- Progress bar for the user -->
        <span id="total" class="label label-info"></span></p>
        <div class="progress progress-striped">
            <div id="progress" rel="tooltip" title="#" class="bar" style="width: 0%;"></div>
        </div>
        <!-- 
            This application uses Disqus to allow users to provide some feedback.
            The next section includes a button that when a user clicks on it will
            load the comments, if any, for the given task
        -->
        <div id="disqus_show_btn" style="margin-top:5px;">
            <button class="btn btn-primary btn-large btn-disqus" onclick="loadDisqus()"><i class="icon-comments"></i> Show comments</button>
            <button class="btn btn-large btn-disqus" onclick="loadDisqus()" style="display:none"><i class="icon-comments"></i> Hide comments</button>
        </div><!-- End of Disqus Button section -->
        <!-- Disqus thread for the given task -->
        <div id="disqus_thread" style="margin-top:5px;display:none"></div>
    </div><!-- End of Question and Submission DIV (column) -->
</div><!-- End of Skeleton Row -->

<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

    /* * * DON'T EDIT BELOW THIS LINE * * */
    function loadDisqus() {
    $("#disqus_thread").toggle();
    $(".btn-disqus").toggle();
    var disqus_shortname = 'pybossa'; 
    //var disqus_identifier = taskId;
    var disqus_developer = 1;

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    }

</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 <script src="http://www.iderail.es/testiss/js/ol.js" type="text/javascript"></script>
 
<script>
function loadUserProgress() {
    pybossa.userProgress('nightcitiesiss').done(function(data){
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'left'}); 
        $("#total").text(data.total);
        $("#done").text(data.done);

    });
}

var xy;
var lonlat;
var clickImg = false;
var clickMap = false;
var urlImage = '';
var urlImageFirst = 'http://eol.jsc.nasa.gov/sseop/images/ESC/small/ISS030/ISS030-E-67805.JPG';

pybossa.taskLoaded(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        console.log('dentro de taskLoaded');

        task.answer = {
            'imageResult' : '',
            'XY': '',
            'LONLAT': '',
            'img_big': task.info.link_big,
            'sharp': ''
        }

        deferred.resolve(task);
    }
    else {
        deferred.resolve(task);
    }
    updateTwitterValues(window.location.href);
});

pybossa.presentTask(function(task, deferred) {
    
    if ( !$.isEmptyObject(task) ) {
        
        loadUserProgress();

        // first time I load the whole map
        if (firstTime){
            loadOSM(task.info.citylon,task.info.citylat,9);
            loadISSImage(task.info.link_big);
            firstTime = false;
        }

        $("#question").html(task.info.question);
        $('#task-id').html(task.id);
        $('.btn-answer').off('click').on('click', function(evt) {
        $("#hrefPicture").attr("href",task.info.linkData);
        $("#fb-like").attr("data-href",task.info.linkData);

            var answer = $(evt.target).attr("value");
            urlImage = task.info.link_big;

            if (typeof answer != 'undefined') {

              if (answer == 'save'){

                console.log('SAVE ');
                $("#step1").hide();
                
                task.answer.XY = readAllValues(document.dataList.xyValues);
                task.answer.LONLAT = readAllValues(document.dataList.lonlatValues);
                xy = '';
                lonlat = '';

                pybossa.saveTask(task.id, task.answer).done(function() {
                    deferred.resolve();
                });

                $("#step1").show();

                changeMapOSM(task.info.citylon,task.info.citylat,9);
                removeAllOptions();
                loadNewISSImage(urlImage);

              }else if (answer == '404'){
                removeAllOptions();
                
                changeMapOSM(task.info.citylon,task.info.citylat,9);
                loadNewISSImage(urlImage);   
                task.answer.imageResult = '404';
                pybossa.saveTask(task.id, task.answer).done(function() {
                    deferred.resolve();
                });  
                
              }else {
                removeAllOptions();
                
                changeMapOSM(task.info.citylon,task.info.citylat,9);
                loadNewISSImage(urlImage);   
                task.answer.imageResult = 'unknown';
                pybossa.saveTask(task.id, task.answer).done(function() {
                    deferred.resolve();
                });  
              }

            }
        });
        $("#loading").hide();
    }
    else {
        $(".skeleton").hide();
        $("#loading").hide();
        $("#finish").fadeIn(500);
    }
});

function updateTwitterValues(share_url) {
    $("#Twitter-share-section").html('&nbsp;'); 
    $("#Twitter-share-section").html('<a href="https://twitter.com/share" class="twitter-share-button" data-url="'+share_url+'" data-text="Check out this amazing image!" data-size="large" data-hashtags="citiesAtNight">Tweet</a>');
    twttr.widgets.load();
}

// functions to show ISS picture and OSM Map
var firstTime = true;
var clickImg = false;
var clickMap = false;

var pixelProjection;


var iconStyle = new ol.style.Style({
  image: new ol.style.Circle({
      radius: 3,
      fill: new ol.style.Fill({
          color: [255, 204, 102, 1]
      }),
      stroke: new ol.style.Stroke({
          color: [255, 204, 102, 1],
          width: 1.5
      })
  }),
  zIndex: 1
});

var iconFeature;

var map;
var ISSlayer;

function createISSLayer(urlImage, imgX, imgY){

     pixelProjection = new ol.proj.Projection({
      code: 'pixel',
      units: 'pixels',
      extent: [0, 0, eval(imgX), eval(imgY)] 

    });;

    ISSlayer = new ol.layer.Image({
        source: new ol.source.ImageStatic({
          attributions: [
            new ol.Attribution({
              html: '<a href="http://guaix.fis.ucm.es/DarkSkies">ISS - GUAIX UCM</a>'
            })
          ],
          url: urlImage,
          imageSize: [eval(imgX), eval(imgY)],
          projection: pixelProjection,
          imageExtent: pixelProjection.getExtent()
        })
      });
}

var dimX,dimY;

function loadISSImage(urlImage){

  var dim = new Array();
  var img = new Image();
  img.onload = function() {
      
      dim[0] = this.width;
      dim[1] = this.height;
      
      dimX = dim[0];
      dimY = dim[1];

      createISSLayer(urlImage, dimX, dimY); 
      
      map = new ol.Map({

        interactions: ol.interaction.defaults().extend([
          new ol.interaction.DragRotateAndZoom()
        ]),
        layers: [ISSlayer],

        target: 'map',

        view: new ol.View2D({
          projection: pixelProjection,
          center: ol.extent.getCenter(pixelProjection.getExtent()),
          zoom: 1
        })
      });

      map.on('click', function(evt) {
        var coordinate = evt.coordinate;
        var xy = ol.coordinate.toStringXY(ol.proj.transform(coordinate, pixelProjection, pixelProjection));

        if (clickImg == false){
          
          addOption(document.dataList.xyValues, xy,xy);

          addPointLayer();
          clickImg = true;
          clickMap = false;

        }
      });
  } // img.load
  img.src = urlImage;
  
} // loadISSImage

function unloadISSImage(){
  window.map.removeLayer(ISSlayer);
}

function loadNewISSImage(urlImage){

  var dim = new Array();
  var img = new Image();
  img.onload = function() {
    
    dim[0] = this.width;
    dim[1] = this.height;
    
    dimX = dim[0];
    dimY = dim[1];
  
    map.removeLayer(ISSlayer);
    createISSLayer(urlImage, dimX, dimY); 
    map.addLayer(ISSlayer);

  } // img.load
  img.src = urlImage;
}



var mapOSM;

function loadOSM(lonOSM, latOSM, zoomOSM){
    mapOSM = new ol.Map({
      target: 'mapOSM',
      layers: [
        new ol.layer.Tile({
          source: new ol.source.OSM()
        })
      ],

      view: new ol.View2D({
        center: ol.proj.transform([eval(lonOSM), eval(latOSM)], 'EPSG:4326', 'EPSG:3857'), 
        zoom: eval(zoomOSM)
      })
    });

    mapOSM.on('click', function(evt) {
      var coordinate = evt.coordinate;
      var hdms = ol.coordinate.toStringHDMS(ol.proj.transform(
          coordinate, 'EPSG:3857', 'EPSG:4326'));

       if (clickMap == false){
        
        var coord = ol.coordinate.toStringXY(ol.proj.transform(coordinate, 'EPSG:3857', 'EPSG:4326'),6);
        addOption(document.dataList.lonlatValues, coord,coord);
        
        addPointLayerOSM();
        clickMap = true;
        clickImg = false;
        
      }
    });

}

function changeMapOSM(lonOSM, latOSM, zoomOSM){

  var view= new ol.View2D({
    center: ol.proj.transform([eval(lonOSM), eval(latOSM)], 'EPSG:4326', 'EPSG:3857'),
    zoom: eval(zoomOSM)
  });
  
  mapOSM.setView(view);
}

function addPointLayer(){

  window.map.removeLayer(pointLayer);

  var pos = [];
  var icons = [];
  
  for(i=0;i<dataList.xyValues.options.length;i++){
    
    if(typeof dataList.xyValues.options[i].value != 'undefined'){
      
      pos = dataList.xyValues.options[i].value.split(',');

      iconFeature = new ol.Feature({ geometry: new ol.geom.Point([eval(pos[0]), eval(pos[1])])});
      iconFeature.setStyle(iconStyle);
      icons.push(iconFeature);    

    }
  }  

  pointLayer = new ol.layer.Vector({ 
    source: new ol.source.Vector({ features: icons }) 
  })
  
  map.addLayer(pointLayer);

}

var pointLayerOSM;
var pointLayer;
function addPointLayerOSM(){

  window.mapOSM.removeLayer(pointLayerOSM);
  var posOSM = [];
  var iconsOSM = [];
  
  for(i=0;i<dataList.lonlatValues.options.length ;i++){
    
    if(typeof dataList.lonlatValues.options[i].value != 'undefined'){
      
      posOSM = dataList.lonlatValues.options[i].value.split(',');

      iconFeatureOSM = new ol.Feature({ geometry: new ol.geom.Point(ol.proj.transform([eval(posOSM[0]), eval(posOSM[1])], 'EPSG:4326', 'EPSG:3857'))});
      iconFeatureOSM.setStyle(iconStyle);
      iconsOSM.push(iconFeatureOSM);    

    }
  }  

  pointLayerOSM = new ol.layer.Vector({ 
    source: new ol.source.Vector({ features: iconsOSM }) 
  })
  
  mapOSM.addLayer(pointLayerOSM);
}

function removePoint(){
  window.map.removeLayer(pointLayer);
  window.mapOSM.removeLayer(pointLayerOSM);
}



// auxiliar functions

function addOption(selectbox,text,value ){
  var optn = document.createElement("OPTION");
  optn.text = text;
  optn.value = value;
  selectbox.options.add(optn);
}


function removeOptions(){
    
    

    var xyDeleted = false;
    for(var i=0; i<dataList.xyValues.options.length;i++){
      
      if(dataList.xyValues.options[i].selected){
        window.map.removeLayer(pointLayer);
        window.mapOSM.removeLayer(pointLayerOSM);
        dataList.xyValues.remove(i);
        dataList.lonlatValues.remove(i);
        xyDeleted = true;
        addPointLayer();
        addPointLayerOSM();
      }
      if( !xyDeleted && dataList.lonlatValues.options[i].selected ){
        window.mapOSM.removeLayer(pointLayerOSM);
        window.map.removeLayer(pointLayer);
        dataList.lonlatValues.remove(i);
        dataList.xyValues.remove(i);
        xyDeleted = false;
        addPointLayerOSM();
        addPointLayer();
      }
    }
    
}

function removeAllOptions(){

    removePoint();

    document.getElementById('xyValues').options.length = 0;
    document.getElementById('lonlatValues').options.length = 0;

}

function readAllValues(selectbox){
  
  var i;
  var ret = new Array();
  for(i=0;i<selectbox.options.length;i++){
    
    if(typeof selectbox.options[i].value != 'undefined'){
      ret.push(selectbox.options[i].value + ';');
    }
  }  
  return ret;
}

function getIimDim(urlimage){
  var dim = new Array();
  var img = new Image();
  img.onload = function() {

    dim[0] = this.width;
    dim[1] = this.height;
    console.log(dim[0]+' '+dim[1]);
  }
  img.src = urlimage;
  return dim;
}

pybossa.run('nightcitiesiss');
</script>